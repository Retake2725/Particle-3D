<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D ç²’å­ç³»çµ± (æ¥µé€Ÿå„ªåŒ–ç‰ˆ)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #video-input { display: none; }

        /* UI é¢æ¿ */
        #ui-panel {
            position: absolute; top: 10px; right: 10px; width: 220px;
            padding: 15px; background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(8px); border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1); color: white;
            z-index: 10;
        }
        h2 { margin: 0 0 10px 0; font-size: 16px; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 12px; color: #aaa; }
        
        .shape-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        button {
            background: rgba(255, 255, 255, 0.1); border: none; padding: 8px;
            color: white; border-radius: 6px; cursor: pointer; font-size: 12px;
        }
        button.active { background: #4a90e2; }
        input[type="color"] { width: 100%; height: 30px; border: none; padding: 0; cursor: pointer; }
        
        #status { font-size: 12px; color: #aaa; margin-top: 10px; text-align: center; white-space: pre-wrap; }
        #fps-counter { position: absolute; top: 5px; left: 5px; color: lime; font-size: 10px; z-index: 5; font-family: monospace; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>
    <div id="fps-counter">FPS: 0</div>
    <video id="video-input" playsinline></video>

    <div id="ui-panel">
        <h2>ğŸš€ æ¥µé€Ÿæ§åˆ¶å°</h2>
        <div class="control-group">
            <div class="shape-buttons">
                <button onclick="setShape('heart')" class="active" id="btn-heart">â¤ï¸ æ„›å¿ƒ</button>
                <button onclick="setShape('saturn')" id="btn-saturn">ğŸª åœŸæ˜Ÿ</button>
                <button onclick="setShape('flower')" id="btn-flower">ğŸŒ¸ èŠ±æœµ</button>
                <button onclick="setShape('fireworks')" id="btn-fireworks">ğŸ† ç…™èŠ±</button>
            </div>
        </div>
        <div class="control-group">
            <label>ç²’å­é¡è‰²</label>
            <input type="color" id="color-picker" value="#ff0055">
        </div>
        <div id="status">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    </div>

    <script>
        // --- 1. Three.js åˆå§‹åŒ– (æ•ˆèƒ½å„ªåŒ–è¨­ç½®) ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.003); // å¢åŠ éœ§æ°£é®è“‹é è™•ç²’å­ï¼Œæå‡è¦–è¦ºæµæš¢æ„Ÿ

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 40;

        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" }); // é—œé–‰åé‹¸é½’ä»¥æå‡æ•ˆèƒ½
        renderer.setSize(window.innerWidth, window.innerHeight);
        // é‡è¦ï¼šé™åˆ¶åƒç´ æ¯”ç‚º 1ï¼Œé¿å…é«˜è§£æåº¦è¢å¹•å¡é “
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1)); 
        document.body.appendChild(renderer.domElement);

        // --- 2. ç²’å­ç³»çµ± (æ¸›é‡å„ªåŒ–) ---
        const particleCount = 3000; // å¾ 15000 é™è‡³ 3000
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(particleCount * 3);
        const targetPositions = new Float32Array(particleCount * 3);
        
        for (let i = 0; i < particleCount * 3; i++) {
            positions[i] = (Math.random() - 0.5) * 80;
            targetPositions[i] = positions[i];
        }
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        const material = new THREE.PointsMaterial({
            size: 0.6, // ç²’å­è®Šå°‘ï¼Œç¨å¾®èª¿å¤§å°ºå¯¸è£œå„Ÿè¦–è¦º
            color: 0xff0055,
            transparent: true,
            opacity: 0.9,
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });

        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        // --- 3. å½¢ç‹€é‚è¼¯ ---
        function setShape(shape) {
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${shape}`).classList.add('active');

            for (let i = 0; i < particleCount; i++) {
                let x, y, z;
                const idx = i * 3;
                if (shape === 'heart') {
                    const t = Math.random() * Math.PI * 2;
                    x = 16 * Math.pow(Math.sin(t), 3);
                    y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                    z = (Math.random() - 0.5) * 10;
                    // éš¨æ©Ÿæ“´æ•£
                    x += (Math.random()-0.5)*2; y += (Math.random()-0.5)*2;
                } else if (shape === 'saturn') {
                    if (Math.random() > 0.3) { // ç’°
                        const angle = Math.random() * Math.PI * 2;
                        const r = 20 + Math.random() * 8;
                        x = Math.cos(angle) * r; z = Math.sin(angle) * r; y = (Math.random()-0.5);
                        // å‚¾æ–œ
                        const tilt = 0.5;
                        let ty = y * Math.cos(tilt) - z * Math.sin(tilt);
                        let tz = y * Math.sin(tilt) + z * Math.cos(tilt);
                        y = ty; z = tz;
                    } else { // çƒ
                        const r = 10;
                        const theta = Math.random() * Math.PI * 2, phi = Math.acos(2*Math.random()-1);
                        x = r*Math.sin(phi)*Math.cos(theta); y = r*Math.sin(phi)*Math.sin(theta); z = r*Math.cos(phi);
                    }
                } else if (shape === 'flower') {
                    const theta = Math.random() * Math.PI * 2;
                    const r = 20 * Math.cos(4 * theta) + Math.random()*3;
                    x = r * Math.cos(theta); y = r * Math.sin(theta); z = (Math.random()-0.5)*5;
                } else if (shape === 'fireworks') {
                    const r = Math.random() * 35;
                    const theta = Math.random()*Math.PI*2, phi = Math.acos(2*Math.random()-1);
                    x = r*Math.sin(phi)*Math.cos(theta); y = r*Math.sin(phi)*Math.sin(theta); z = r*Math.cos(phi);
                }
                targetPositions[idx] = x; targetPositions[idx+1] = y; targetPositions[idx+2] = z;
            }
        }
        setShape('heart');
        document.getElementById('color-picker').addEventListener('input', e => material.color.set(e.target.value));

        // --- 4. æ··åˆæ‰‹å‹¢è­˜åˆ¥é‚è¼¯ (å–®æ‰‹/é›™æ‰‹) ---
        let handScale = 1.0;
        const statusDiv = document.getElementById('status');
        
        function onResults(results) {
            const hands = results.multiHandLandmarks;
            
            if (hands && hands.length === 2) {
                // [æ¨¡å¼ A] é›™æ‰‹ï¼šè¨ˆç®—å…©æ‰‹æŒå¿ƒè·é›¢
                const d = Math.hypot(hands[0][9].x - hands[1][9].x, hands[0][9].y - hands[1][9].y);
                // æ˜ å°„é‚è¼¯ï¼šè·é›¢ 0.1~0.6 -> ç¸®æ”¾ 0.5~2.5
                let targetScale = (d - 0.1) * (2.0 / 0.5) + 0.5;
                updateScale(targetScale, "ğŸ™Œ é›™æ‰‹æ¨¡å¼\nè·é›¢æ§åˆ¶ç¸®æ”¾");
                
            } else if (hands && hands.length === 1) {
                // [æ¨¡å¼ B] å–®æ‰‹ï¼šè¨ˆç®—ã€Œæ‹‡æŒ‡(4)ã€èˆ‡ã€Œé£ŸæŒ‡(8)ã€æŒ‡å°–è·é›¢ (Pinch)
                const h = hands[0];
                const pinchDist = Math.hypot(h[4].x - h[8].x, h[4].y - h[8].y);
                
                // æåˆè·é›¢é€šå¸¸åœ¨ 0.02 (é–‰åˆ) åˆ° 0.2 (å¼µé–‹) ä¹‹é–“
                // æˆ‘å€‘å¸Œæœ›ï¼šå¼µé–‹ = å¤§ (2.0), æåˆ = å° (0.5)
                let targetScale = (pinchDist - 0.02) * (1.5 / 0.15) + 0.5;
                updateScale(targetScale, "â˜ï¸ å–®æ‰‹æ¨¡å¼\næåˆæŒ‡å°–æ§åˆ¶");
                
            } else {
                statusDiv.innerText = "ğŸ‘€ æœªåµæ¸¬åˆ°æ‰‹å‹¢\n(è‡ªå‹•å±•ç¤ºæ¨¡å¼)";
                statusDiv.style.color = "#888";
                // ç„¡æ‰‹å‹¢æ™‚ç·©æ…¢å‘¼å¸æ•ˆæœ
                handScale = 1.0 + Math.sin(Date.now() * 0.002) * 0.2;
            }
        }

        function updateScale(target, msg) {
            // å¹³æ»‘éæ¸¡ (Lerp) é˜²æ­¢æ•¸å€¼è·³å‹•
            target = Math.max(0.3, Math.min(target, 3.0)); // é™åˆ¶ç¯„åœ
            handScale += (target - handScale) * 0.1; 
            
            statusDiv.innerText = msg;
            statusDiv.style.color = "#4cd964";
        }

        // --- 5. MediaPipe åˆå§‹åŒ– (è¼•é‡ç‰ˆ) ---
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 0, // 0 = Lite (æœ€å¿«), 1 = Full (æº–ç¢º) -> æ”¹ç‚º 0 æ•‘æ•ˆèƒ½
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        hands.onResults(onResults);

        const cam = new Camera(document.getElementById('video-input'), {
            onFrame: async () => { await hands.send({image: document.getElementById('video-input')}); },
            width: 320, height: 240 // å¤§å¹…é™ä½å½±åƒåˆ†æè§£æåº¦ (ä¸å½±éŸ¿é¡¯ç¤ºï¼Œåªå½±éŸ¿ AI åˆ†æé€Ÿåº¦)
        });
        cam.start();

        // --- 6. æ¸²æŸ“å¾ªç’° ---
        let lastTime = 0;
        const fpsDiv = document.getElementById('fps-counter');

        function animate(time) {
            requestAnimationFrame(animate);
            
            // FPS è¨ˆç®—
            if (time - lastTime > 1000) {
                fpsDiv.innerText = `FPS: ${Math.round(1000 / (time - lastTime) * 60)}`; // ç²—ç•¥ä¼°ç®—
                lastTime = time;
            }

            const positions = particles.geometry.attributes.position.array;
            
            // å„ªåŒ–å¾Œçš„ç²’å­è¿´åœˆ
            for (let i = 0; i < particleCount; i++) {
                const idx = i * 3;
                
                // æ¸›å°‘ lerp çš„è¨ˆç®—é‡ï¼Œç›´æ¥ç®—å·®å€¼
                const tx = targetPositions[idx] * handScale;
                const ty = targetPositions[idx+1] * handScale;
                const tz = targetPositions[idx+2] * handScale;

                // é€Ÿåº¦ä¿‚æ•¸ 0.1
                positions[idx]   += (tx - positions[idx]) * 0.1;
                positions[idx+1] += (ty - positions[idx+1]) * 0.1;
                positions[idx+2] += (tz - positions[idx+2]) * 0.1;
            }
            
            particles.geometry.attributes.position.needsUpdate = true;
            particles.rotation.y += 0.002; // ç·©æ…¢è‡ªè½‰
            renderer.render(scene, camera);
        }
        animate(0);

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
